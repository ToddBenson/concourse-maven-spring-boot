resource_types:
- name: pull-request
  type: docker-image
  source:
    repository: jtarchie/pr

resources:
- name: SAST-pr
  type: pull-request
  source:
    repo: {{repo}}
    access_token: {{git-repo-token}}

- name: git-repo
  type: git
  source:
    uri: {{git-repo}}
    username: {{git-username}}
    password: {{git-password}}

- name: sast-image
  type: docker-image
  source:
    repository: tgbenson/jssast
    tag: latest


jobs:
- name: predeploy-SAST-test
  plan:
  - get: git-repo
    trigger: true
  - get: sast-image
  - task: unit
    file: git-repo/predeploy-sast.yml
    image: sast-image
    params:
      GIT_REPO_TOKEN: {{git-repo-token}}
      SONAR_TOKEN: {{sonar-token}}
      SONAR_JAVA_BINARIES: {{sonar-java-binaries}}
      SONAR_SOURCES: {{sonar-sources}}
      SONAR_PROJECT_VERSION: {{sonar-project-version}}
      SONAR_PROJECT_NAME: {{sonar-project-name}}
      SONAR_PROJECT_KEY: {{sonar-project-key}}
      SONAR_URL: {{sonar-url}}
#  - task: unit
#    config:
#      image_resource:
#        type: docker-image$REPO
#        source:
#          repository: tgbenson/jssast
#      inputs:
#        - name: git-repo
#      platform: linux
#      run:
#        path: sh
#        args: ['-c', 'cd git-repo;retire --path . --outputformat text --outputpath retire.txt;eslint -c /opt/configs/static/.eslintrc --debug . -o ./eslint.txt;./mvnw clean install findbugs:findbugs;cat *.txt;sonar-scanner -Dsonar.host.url=http://10.37.128.36:9000 -Dsonar.projectKey=my:project -Dsonar.projectName=concourse-maven-spring-boot -Dsonar.projectVersion=1.0 -Dsonar.sources=./src/main/java/hello -Dsonar.java.binaries=./target/classes -Dsonar.github.repository=ToddBenson/concourse-maven-spring-boot -Dsonar.github.oauth=ebf39265ab4de4329a9fbbeab50fe2882e0e2088 -Dsonar.login=607632a7d4379a3b1369f5a123bae8f87ddc83b1']

- name: pr-SAST-test
  plan:
  - get: SAST-pr
    trigger: true
  - get: git-repo
  - get: sast-image
  - put: SAST-pr
    params:
      path: SAST-pr
      status: pending
  - task: unit
#    config:
#      image_resource:
#        type: docker-image
#        source:
#          repository: tgbenson/jssast
#      inputs:
#      - name: SAST-pr
#      platform: linux
#      run:
#        path: sh
#        args: ['-c', 'cd SAST-pr;retire --path . --outputformat text --outputpath retire.txt;eslint -c /opt/configs/static/.eslintrc --debug . -o ./eslint.txt;./mvnw clean install findbugs:findbugs;cat *.txt;sonar-scanner -Dsonar.host.url=http://10.37.128.36:9000 -Dsonar.projectKey=my:project -Dsonar.projectName=concourse-maven-spring-boot -Dsonar.projectVersion=1.0 -Dsonar.sources=./src/main/java/hello -Dsonar.java.binaries=./target/classes -Dsonar.analysis.mode=preview -Dsonar.github.pullRequest=$(git config --get pullrequest.id) -Dsonar.github.repository=ToddBenson/concourse-maven-spring-boot -Dsonar.github.oauth=ebf39265ab4de4329a9fbbeab50fe2882e0e2088 -Dsonar.login=607632a7d4379a3b1369f5a123bae8f87ddc83b1']
    file: git-repo/pr-sast.yml
    image: sast-image
    params:
      GIT_REPO_TOKEN: {{git-repo-token}}
      SONAR_TOKEN: {{sonar-token}}
      SONAR_JAVA_BINARIES: {{sonar-java-binaries}}
      SONAR_SOURCES: {{sonar-sources}}
      SONAR_PROJECT_VERSION: {{sonar-project-version}}
      SONAR_PROJECT_NAME: {{sonar-project-name}}
      SONAR_PROJECT_KEY: {{sonar-project-key}}
      SONAR_URL: {{sonar-url}}
    on_success:
      put: SAST-pr
      params:
        path: SAST-pr
        status: success
    on_failure:
      put: SAST-pr
      params:
        path: SAST-pr
        status: failure
